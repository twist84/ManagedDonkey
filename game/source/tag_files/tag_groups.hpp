#pragma once

#include "cseries/cseries.hpp"
#include "tag_files/tag_group_definitions.hpp"

#define ACHIEVEMENTS_TAG 'achi'
#define AI_DIALOGUE_GLOBALS_TAG 'adlg'
#define AI_GLOBALS_TAG 'aigl'
#define AI_MISSION_DIALOGUE_TAG 'mdlg'
#define ANTENNA_TAG 'ant!'
#define AREA_SCREEN_EFFECT_TAG 'sefc'
#define ARMOR_SOUNDS_TAG 'arms'
#define BEAM_SYSTEM_TAG 'beam'
#define BINK_TAG 'bink'
#define BIPED_TAG 'bipd'
#define BITMAP_TAG 'bitm'
#define BREAKABLE_SURFACE_TAG 'bsdt'
#define CACHE_FILE_GLOBAL_TAGS_TAG 'cfgt'
#define CACHE_FILE_RESOURCE_GESTALT_TAG 'zone'
#define CACHE_FILE_SOUND_TAG '$#! '
#define CAMERA_FX_SETTINGS_TAG 'cfxs'
#define CAMERA_TRACK_TAG 'trak'
#define CAMO_TAG 'cmoe'
#define CELLULAR_AUTOMATA2D_TAG 'whip'
#define CELLULAR_AUTOMATA_TAG 'devo'
#define CHARACTER_TAG 'char'
#define CHOCOLATE_MOUNTAIN_NEW_TAG 'chmt'
#define CHUD_ANIMATION_DEFINITION_TAG 'chad'
#define CHUD_DEFINITION_TAG 'chdt'
#define CHUD_GLOBALS_DEFINITION_TAG 'chgd'
#define CHUD_WIDGET_PARALLAX_DATA_TAG 'cprl'
#define CINEMATIC_SCENE_TAG 'cisc'
#define CINEMATIC_TAG 'cine'
#define CLOTH_TAG 'clwd'
#define COLLISION_DAMAGE_TAG 'cddf'
#define COLLISION_MODEL_TAG 'coll'
#define COLOR_TABLE_TAG 'colo'
#define CONTRAIL_SYSTEM_TAG 'cntl'
#define CORTANA_EFFECT_DEFINITION_TAG 'crte'
#define CRATE_TAG 'bloc'
#define CREATURE_TAG 'crea'
#define DAMAGE_EFFECT_TAG 'jpt!'
#define DAMAGE_RESPONSE_DEFINITION_TAG 'drdf'
#define DECAL_SYSTEM_TAG 'decs'
#define DECORATOR_SET_TAG 'dctr'
#define DETAIL_OBJECT_COLLECTION_TAG 'dobc'
#define DEVICE_ARG_DEVICE_TAG 'argd'
#define DEVICE_CONTROL_TAG 'ctrl'
#define DEVICE_MACHINE_TAG 'mach'
#define DEVICE_TAG 'devi'
#define DEVICE_TERMINAL_TAG 'term'
#define DIALOGUE_TAG 'udlg'
#define EFFECT_GLOBALS_TAG 'effg'
#define EFFECT_SCENERY_TAG 'efsc'
#define EFFECT_TAG 'effe'
#define EQUIPMENT_TAG 'eqip'
#define FLOCK_TAG 'flck'
#define FLUID_DYNAMICS_TAG 'fldy'
#define FORMATION_TAG 'form'
#define FRAGMENT_TAG 'frag'
#define GAME_ENGINE_SETTINGS_DEFINITION_TAG 'wezr'
#define GAME_PROGRESSION_TAG 'gpdt'
#define GFX_TEXTURES_LIST_TAG 'gfxt'
#define GIANT_TAG 'gint'
#define GLOBALS_TAG 'matg'
#define GLOBAL_PIXEL_SHADER_TAG 'glps'
#define GLOBAL_VERTEX_SHADER_TAG 'glvs'
#define GUI_BITMAP_WIDGET_DEFINITION_TAG 'bmp3'
#define GUI_BUTTON_KEY_DEFINITION_TAG 'bkey'
#define GUI_DATASOURCE_DEFINITION_TAG 'dsrc'
#define GUI_GROUP_WIDGET_DEFINITION_TAG 'grup'
#define GUI_LIST_WIDGET_DEFINITION_TAG 'lst3'
#define GUI_MODEL_WIDGET_DEFINITION_TAG 'mdl3'
#define GUI_SCREEN_WIDGET_DEFINITION_TAG 'scn3'
#define GUI_SKIN_DEFINITION_TAG 'skn3'
#define GUI_TEXT_WIDGET_DEFINITION_TAG 'txt3'
#define GUI_WIDGET_ANIMATION_COLLECTION_DEFINITION_TAG 'wacd'
#define GUI_WIDGET_ANIMATION_DEFINITION_TAG 'wgan'
#define GUI_WIDGET_COLOR_ANIMATION_DEFINITION_TAG 'wclr'
#define GUI_WIDGET_FONT_ANIMATION_DEFINITION_TAG 'wfon'
#define GUI_WIDGET_POSITION_ANIMATION_DEFINITION_TAG 'wpos'
#define GUI_WIDGET_ROTATION_ANIMATION_DEFINITION_TAG 'wrot'
#define GUI_WIDGET_SCALE_ANIMATION_DEFINITION_TAG 'wscl'
#define GUI_WIDGET_SPRITE_ANIMATION_DEFINITION_TAG 'wspr'
#define GUI_WIDGET_TEXTURE_COORDINATE_ANIMATION_DEFINITION_TAG 'wtuv'
#define HLSL_INCLUDE_TAG 'hlsl'
#define INPUT_GLOBALS_TAG 'inpg'
#define ITEM_COLLECTION_TAG 'itmc'
#define ITEM_TAG 'item'
#define LEAF_SYSTEM_TAG 'lswd'
#define LENS_FLARE_TAG 'lens'
#define LIGHT_TAG 'ligh'
#define LIGHT_VOLUME_SYSTEM_TAG 'ltvl'
#define MATERIAL_EFFECTS_TAG 'foot'
#define METER_TAG 'metr'
#define MODEL_ANIMATION_GRAPH_TAG 'jmad'
#define MODEL_TAG 'hlmt'
#define MUFFIN_TAG 'mffn'
#define MULTILINGUAL_UNICODE_STRING_LIST_TAG 'unic'
#define MULTIPLAYER_GLOBALS_TAG 'mulg'
#define MULTIPLAYER_SCENARIO_DESCRIPTION_TAG 'mply'
#define MULTIPLAYER_VARIANT_SETTINGS_INTERFACE_DEFINITION_TAG 'goof'
#define NEW_CINEMATIC_LIGHTING_TAG 'nclt'
#define OBJECT_TAG 'obje'
#define PARTICLE_EMITTER_CUSTOM_POINTS_TAG 'pecp'
#define PARTICLE_MODEL_TAG 'pmdf'
#define PARTICLE_PHYSICS_TAG 'pmov'
#define PARTICLE_TAG 'prt3'
#define PATCHY_FOG_TAG 'fpch'
#define PERFORMANCE_THROTTLES_TAG 'perf'
#define PHYSICS_MODEL_TAG 'phmo'
#define PIXEL_SHADER_TAG 'pixl'
#define PLANAR_FOG_TAG 'fog '
#define PODIUM_SETTINGS_TAG 'pdm!'
#define POINT_PHYSICS_TAG 'pphy'
#define PROJECTILE_TAG 'proj'
#define RASTERIZER_CACHE_FILE_GLOBALS_TAG 'draw'
#define RASTERIZER_GLOBALS_TAG 'rasg'
#define RENDER_METHOD_DEFINITION_TAG 'rmdf'
#define RENDER_METHOD_OPTION_TAG 'rmop'
#define RENDER_METHOD_TAG 'rm  '
#define RENDER_METHOD_TEMPLATE_TAG 'rmt2'
#define RENDER_MODEL_TAG 'mode'
#define RENDER_WATER_RIPPLE_TAG 'rwrd'
#define SANDBOX_TEXT_VALUE_PAIR_DEFINITION_TAG 'jmrq'
#define SCENARIO_AI_RESOURCE_TAG 'ai**'
#define SCENARIO_BIPEDS_RESOURCE_TAG '*ipd'
#define SCENARIO_CINEMATICS_RESOURCE_TAG 'cin*'
#define SCENARIO_CLUSTER_DATA_RESOURCE_TAG 'clu*'
#define SCENARIO_COMMENTS_RESOURCE_TAG '/**/'
#define SCENARIO_CREATURE_RESOURCE_TAG '*rea'
#define SCENARIO_CUBEMAP_RESOURCE_TAG 'cub*'
#define SCENARIO_DECALS_RESOURCE_TAG 'dec*'
#define SCENARIO_DECORATORS_RESOURCE_TAG 'dc*s'
#define SCENARIO_DEVICES_RESOURCE_TAG 'dgr*'
#define SCENARIO_EFFECT_SCENERY_RESOURCE_TAG '*fsc'
#define SCENARIO_EQUIPMENT_RESOURCE_TAG '*qip'
#define SCENARIO_FAUX_DATA_TAG 'sFdT'
#define SCENARIO_HS_SOURCE_FILE_TAG 'hsc*'
#define SCENARIO_LIGHTMAP_BSP_DATA_TAG 'Lbsp'
#define SCENARIO_LIGHTMAP_TAG 'sLdT'
#define SCENARIO_LIGHTS_RESOURCE_TAG '*igh'
#define SCENARIO_PDA_TAG 'spda'
#define SCENARIO_SCENERY_RESOURCE_TAG '*cen'
#define SCENARIO_SKY_REFERENCES_RESOURCE_TAG 'sky*'
#define SCENARIO_SOUND_SCENERY_RESOURCE_TAG '*sce'
#define SCENARIO_STRUCTURE_BSP_TAG 'sbsp'
#define SCENARIO_STRUCTURE_LIGHTING_INFO_TAG 'stli'
#define SCENARIO_STRUCTURE_LIGHTING_RESOURCE_TAG 'sslt'
#define SCENARIO_TAG 'scnr'
#define SCENARIO_TRIGGER_VOLUMES_RESOURCE_TAG 'trg*'
#define SCENARIO_VEHICLES_RESOURCE_TAG '*ehi'
#define SCENARIO_WEAPONS_RESOURCE_TAG '*eap'
#define SCENERY_TAG 'scen'
#define SCREEN_EFFECT_TAG 'egor'
#define SHADER_BEAM_TAG 'rmb '
#define SHADER_BLACK_TAG 'rmbk'
#define SHADER_CONTRAIL_TAG 'rmc\0'
#define SHADER_CORTANA_TAG 'rmct'
#define SHADER_CUSTOM_TAG 'rmcs'
#define SHADER_DECAL_TAG 'rmd '
#define SHADER_FOLIAGE_TAG 'rmfl'
#define SHADER_HALOGRAM_TAG 'rmhg'
#define SHADER_LIGHT_VOLUME_TAG 'rmlv'
#define SHADER_PARTICLE_TAG 'rmp\0'
#define SHADER_SCREEN_TAG 'rmss'
#define SHADER_SKIN_TAG 'rmsk'
#define SHADER_TAG 'rmsh'
#define SHADER_TERRAIN_TAG 'rmtr'
#define SHADER_WATER_TAG 'rmw '
#define SHADER_ZONLY_TAG 'rmzo'
#define SHIELD_IMPACT_TAG 'shit'
#define SKY_ATM_PARAMETERS_TAG 'skya'
#define SOUND_CACHE_FILE_GESTALT_TAG 'ugh!'
#define SOUND_CLASSES_TAG 'sncl'
#define SOUND_DIALOGUE_CONSTANTS_TAG 'spk!'
#define SOUND_EFFECT_COLLECTION_TAG 'sfx+'
#define SOUND_EFFECT_TEMPLATE_TAG '<fx>'
#define SOUND_ENVIRONMENT_TAG 'snde'
#define SOUND_GLOBAL_PROPAGATION_TAG 'sgp!'
#define SOUND_LOOPING_TAG 'lsnd'
#define SOUND_MIX_TAG 'snmx'
#define SOUND_SCENERY_TAG 'ssce'
#define SOUND_TAG 'snd!'
#define SOUND_UI_SOUNDS_TAG 'sus!'
#define SQUAD_TEMPLATE_TAG 'sqtm'
#define STEREO_SYSTEM_TAG 'BooM'
#define STRUCTURE_DESIGN_TAG 'sddt'
#define STRUCTURE_SEAMS_TAG 'stse'
#define STYLE_TAG 'styl'
#define SURVIVAL_MODE_GLOBALS_TAG 'smdt'
#define TAG_TEMPLATE_UNIT_TEST_TAG 'uttt'
#define TEST_TAG_TAG 'ttag'
#define TEXTURE_RENDER_LIST_TAG 'trdf'
#define TEXT_VALUE_PAIR_DEFINITION_TAG 'sily'
#define UNIT_TAG 'unit'
#define USER_INTERFACE_FOURTH_WALL_TIMING_DEFINITION_TAG 'fwtg'
#define USER_INTERFACE_GLOBALS_DEFINITION_TAG 'wgtz'
#define USER_INTERFACE_SHARED_GLOBALS_DEFINITION_TAG 'wigl'
#define USER_INTERFACE_SOUNDS_DEFINITION_TAG 'uise'
#define VEHICLE_COLLECTION_TAG 'vehc'
#define VEHICLE_TAG 'vehi'
#define VERTEX_SHADER_TAG 'vtsh'
#define VFILES_LIST_TAG 'vfsl'
#define VISION_MODE_TAG 'vmdx'
#define WEAPON_TAG 'weap'
#define WIND_TAG 'wind'

#define UPDATE_REFERENCE_NAMES(_block_reference) for (auto& _element : _block_reference) _element.update_reference_names()

struct s_tag_block
{
	long count;
	byte(&elements)[];
	long : 32; // byte* definition;
};
static_assert(sizeof(s_tag_block) == 0xC);

struct s_tag_reference
{
	tag group_tag;
	char const* name;
	long name_length;
	long index;

	void* get_definition();

	template<typename t_type>
	t_type* cast_to()
	{
		return static_cast<t_type*>(get_definition());
	}

	char const* get_name();
	char const* get_group_name();
};
static_assert(sizeof(s_tag_reference) == 0x10);

struct s_tag_data
{
	long size;
	long : 32; //  flags;
	long : 32; // long stream_position;
	byte(&base)[];
	long : 32; // byte* definition;
};
static_assert(sizeof(s_tag_data) == 0x14);

template<typename t_element_type, dword ...t_extra>
//using c_typed_tag_block = s_tag_block;
struct c_typed_tag_block
{
public:
	long count()
	{
		return m_count;
	}

	t_element_type* begin()
	{
		return m_elements;
	}

	t_element_type* end()
	{
		return m_elements + m_count;
	}

	t_element_type& operator[](long index)
	{
		ASSERT(VALID_INDEX(index, m_count));

		return m_elements[index];
	}

	void clear()
	{
		csmemset(m_elements, 0, sizeof(m_elements) * m_count);
		m_count = 0;
	}

//protected:
	long m_count;
	t_element_type* m_elements;
	long : 32; // byte* definition;
};

template<tag ...k_group_tags>
using c_typed_tag_reference = s_tag_reference;

template<typename t_data_type, dword ...t_extra>
//using c_typed_tag_data = s_tag_data;
struct c_typed_tag_data : s_tag_data
{
	t_data_type* get()
	{
		return reinterpret_cast<t_data_type*>(base);
	}
};

struct s_cache_file_tag_group
{
	tag group_tags[3];
	c_string_id name;
};
static_assert(sizeof(s_cache_file_tag_group) == 0x10);

extern s_cache_file_tag_group const global_tag_groups[];
extern long const global_tag_group_count;

extern void __cdecl tag_load_missing_tags_report();
extern char const* __cdecl tag_name_strip_path(char const* path);
extern wchar_t const* __cdecl tag_name_strip_path(wchar_t const* path);
extern tag group_name_to_group_tag(char const* group_name);

